function PublishController(){Controller.call(this),this.initPage(),this.initStar(),this.getLocation(),this.getDetails(),this.bindEvent()}PublishController.prototype.initPage=function(){var e=this;e.openId=e.getQueryStringByName("openId"),e.localIds=null,e.country="中国",e.city="上海",e.latitude="38.65777",e.longitude="104.08296";new WechatShareController({wxConfigCallback:function(e){$(".wrapper").css("z-index","100")},canShareTimeline:!1,canShareAppMessage:!1})},PublishController.prototype.initStar=function(){$("#star").length&&$("#star").remove(),$("body").append('<div id="star"></div>'),$("#star").height($(document).height()).starfield({starDensity:1,mouseScale:1,seedMovement:!1}).height(0)},PublishController.prototype.getDetails=function(){var e=this;e.request(e.apiUrl.annualmeeting.getPhotoInfoByOpenId,{openId:e.openId},{process:function(e){e&&e.data&&e.data.length>0&&($("#txtUserName").val(e.data[0].userName),$("#txtMobile").val(e.data[0].userPhone))}})},PublishController.prototype.getLocation=function(){var e,t,o,i=this,n="http://api.map.baidu.com/geocoder/v2/?ak=qNYWrlPhhs31jXqbHLMnKWrI&location=#positionInfo#&output=json&pois=1",s=new BMap.Geolocation;s.getCurrentPosition(function(s){this.getStatus()==BMAP_STATUS_SUCCESS?(e=s.point.lng,t=s.point.lat,i.latitude=t,i.longitude=e,o=n.replace("#positionInfo#",t+","+e),$.ajax({url:o,type:"GET",dataType:"jsonp",success:function(e){i.country=e.result.addressComponent.country,i.city=e.result.addressComponent.city.replace("市",""),$(".location-info").find(".country").html(e.result.addressComponent.country).css("visibility","visible"),$(".location-info").find(".city").html(e.result.addressComponent.city.replace("市","")).css("visibility","visible")},error:function(){$(".location-info").find(".country").html("中国").css("visibility","visible"),$(".location-info").find(".city").html("上海").css("visibility","visible")}})):console.log("failed"+this.getStatus())},{enableHighAccuracy:!0})},PublishController.prototype.bindEvent=function(){var e=this;$(".choose-box").on("click",function(){wx.chooseImage({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success:function(t){t.localIds&&t.localIds.length>0&&(e.localId=t.localIds[0],$(".choose-box").find(".icon").hide(),$(".choose-box").find("img").attr("src",e.localId).show())}})}),$(".button").on("click",function(){var t=$(this),o=$.trim($("#txtMobile").val()),i=$.trim($("#txtUserName").val()),n=t.attr("data-original-localid"),s=!0;if(!t.hasClass("disabled")){if(!e.localId)return void e.tips("请上传照片");if(!i.length)return void e.tips("请输入名字");if(i.length>20)return void e.tips("名字不能超过20个字");if(!o.length)return void e.tips("请输入手机号");if(!/^1[34578]\d{9}$/.test(o))return void e.tips("请输入合法的手机号");n&&(e.localId=n)&&(s=!1),t.attr("data-original-localid",e.localId),t.hide().addClass("disabled"),$(".uploading").css("display","inline-block"),s?wx.uploadImage({localId:e.localId,isShowProgressTips:1,success:function(n){serverId=n.serverId,e.serverId=serverId,e.request(e.apiUrl.annualmeeting.addPhoto,{openId:e.openId,latitude:e.latitude,longitude:e.longitude,country:e.country,city:e.city,userName:i,userPhone:o,media_id:serverId},{process:function(t){window.location="/ay/success.html?openId="+e.openId},onExceptionInterface:function(o){e.tips(o.message),t.removeClass("disabled").show(),$(".uploading").hide()},onErrorInterface:function(){e.tips("网络异常，请稍后尝试!"),t.removeClass("disabled").show(),$(".uploading").hide()}})}}):e.request(e.apiUrl.annualmeeting.addPhoto,{openId:e.openId,latitude:e.latitude,longitude:e.longitude,country:e.country,city:e.city,userName:i,userPhone:o,media_id:e.serverId},{process:function(t){window.location="/ay/success.html?openId="+e.openId},onExceptionInterface:function(o){e.tips(o.message),t.removeClass("disabled").show(),$(".uploading").hide()},onErrorInterface:function(){e.tips("网络异常，请稍后尝试!"),t.removeClass("disabled").show(),$(".uploading").hide()}})}}),$("body").delegate("#mask-container","click",function(e){$(".dialog").hide(),$("#mask-container").remove()})},$(document).ready(function(){new PublishController});